@model (string, HashSet<string>)

@using BiblioMit.Services

@{
    var style = $"{Model.Item1}Styles";
    var script = $"{Model.Item1}Scripts";
    bool dev = false;
    @*<environment exclude="Development">
        @{
            dev = false;
        }
    </environment>*@
    foreach (var lib in Model.Item2)
    {
        var bundles = Bundler.GetBundles(lib);
        var continuar = false;
        if (bundles != null && bundles.Any()) 
        { 
            foreach (var bundle in bundles)
            {
                var file = bundle.OutputFileName.Replace("wwwroot", "~");
                if (file.Contains(".css"))
                {
                    if (dev)
                    {
                        foreach (var input in bundle.InputFiles)
                        {
                            this.Block(style, @<link href="@input.Insert(0, "~/")" rel="stylesheet" asp-append-version="true" />);
                        }
                    }
                    else
                    {
                        this.Block(style, @<link href="@file" rel="stylesheet" asp-append-version="true" />);
                    }
                }
                else
                {
                    if (dev)
                    {
                        foreach (var input in bundle.InputFiles)
                        {
                            this.Block(script, @<script src="@input.Insert(0, "~/")" asp-append-version="true"></script>);
                        }
                    }
                    else
                    {
                        this.Block(script, @<script src="@file" asp-append-version="true"></script>);
                    }
                }
                continuar = true;
            }
        }
        if (continuar) { continue;}
        var l = Libman.GetLibs(lib);
        if (l != null) { foreach (var file in l.Files)
        {
            if (dev)
            {
                if (file.Contains(".css"))
                {
                    this.Block(style, @<link href="@($"{l.Destination.Replace("wwwroot", "")}/{file}")" rel="stylesheet" />);
                }
                else if (file.Contains(".js"))
                {
                    this.Block(script, @<script src="@($"{l.Destination.Replace("wwwroot", "")}/{file}")"></script>);
                }
            }
            else
            {
                var url = "unpkg.com";
                switch (l.Provider)
                {
                    case "cdnjs":
                    l.Library = l.Library.Replace("@", "/");
                    url = "cdnjs.cloudflare.com/ajax/libs";
                    break;
                    case "":
                    default:
                    l.Provider = "unpkg";
                    break;
                }
                if (file.Contains(".css"))
                {
                    this.Block(style, @<link href="@($"{Context.Request.Scheme}://{url}/{l.Library}/{file}")" rel="stylesheet"
                                  asp-fallback-href="@($"{l.Destination.Replace("wwwroot", "")}/{file}")"
                                  asp-subresource-integrity-href="@($"{l.Destination}/{file}")"
                                      />);
                }
                else if (file.Contains(".js"))
                {
                    this.Block(script, @<script src="@($"{Context.Request.Scheme}://{url}/{l.Library}/{file}")"
                                    asp-fallback-src="@($"{l.Destination.Replace("wwwroot", "")}/{file}")"
                                    asp-subresource-integrity-src="@($"{l.Destination}/{file}")"
                                        ></script>);
                }
            }
        }}
    }
}
