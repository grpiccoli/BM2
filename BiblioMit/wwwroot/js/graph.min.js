var __awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})},__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},loaderStart=function(){document.getElementById("preloader-background").style.display="block"},loaderStop=function(){document.getElementById("preloader-background").style.display="none"},psmb,variables,opts,noop,passive,clickMap;loaderStart();var Area=function(n){return(google.maps.geometry.spherical.computeArea(n)/1e4).toFixed(2)},flatten=function(n){var t=[];return n.forEach(function(n){Array.isArray(n)?t.push.apply(t,flatten(n)):t.push(n)}),t},getBounds=function(n){var t=new google.maps.LatLngBounds;return flatten(n).forEach(function(n){return t.extend(n)}),t},selected="red",lang=$("html").attr("lang"),esp=lang==="es",choiceOps={maxItemCount:50,removeItemButton:!0,duplicateItemsAllowed:!1,paste:!1,searchResultLimit:10,shouldSort:!1,fuseOptions:{include:"score"}};esp&&(choiceOps.searchPlaceholderValue="Buscar",choiceOps.loadingText="Cargando...",choiceOps.noResultsText="Sin resultados",choiceOps.noChoicesText="Sin opciones a elegir",choiceOps.itemSelectText="Presione para seleccionar",choiceOps.maxItemText=function(n){return"Máximo "+n+" valores"});var semaforo=!document.getElementById("semaforo").classList.contains("d-none"),epsmb=document.getElementById("psmb"),evariable=document.getElementById("variable"),etl=document.getElementById("tl");choiceOps.placeholderValue=esp?"Seleccione áreas":"Select areas";psmb=new Choices(epsmb,choiceOps);choiceOps.placeholderValue=esp?"Seleccione variables":"Select Variables";variables=new Choices(evariable,choiceOps);choiceOps.placeholderValue=esp?"Variables semáforo":"Semaforo Variables";var tl=new Choices(etl,choiceOps),map=new google.maps.Map(document.getElementById("map"),{mapTypeId:"terrain"}),infowindow=new google.maps.InfoWindow({maxWidth:500}),tableInfo=[],polygons={},bnds=new google.maps.LatLngBounds,markers=[],titles=esp?["Código","Comuna","Provincia","Región","Área","Fuentes"]:["Code","Commune","Province","Region","Area","Sources"],showInfo=function(){var n=this.zIndex,t="<h4>"+tableInfo[n].name+'<\/h4><table class="table"><tr><th scope="row">'+titles[0]+'<\/th><td align="right">'+tableInfo[n].code+"<\/td><\/tr>";tableInfo[n].comuna!==null&&(t+='<tr><th scope="row">'+titles[1]+'<\/th><td align="right">'+tableInfo[n].comuna+"<\/td><\/tr>");tableInfo[n].provincia!==null&&(t+='<tr><th scope="row">'+titles[2]+'<\/th><td align="right">'+tableInfo[n].provincia+"<\/td><\/tr>");t+='<tr><th scope="row">'+titles[3]+'<\/th><td align="right">Los Lagos<\/td>\n<\/tr><tr><th scope="row">'+titles[4]+' (ha)<\/th>\n<td align="right">'+Area(polygons[n].getPath().getArray())+'<\/td>\n<\/tr>\n<tr><th scope="row">'+titles[5]+'<\/th><td><\/td><\/tr>\n<tr><td>Sernapesca<\/td>\n<td align="right">\n<a target="_blank" href="https://www.sernapesca.cl">\n<img src="../images/ico/sernapesca.svg" height="20" /><\/a><\/td><\/tr>\n<tr><td>PER Mitílidos<\/td>\n<td align="right">\n<a target="_blank" href="https://www.mejillondechile.cl">\n<img src="../images/ico/mejillondechile.min.png" height="20" /><\/a><\/td><\/tr>\n<tr><td>Subpesca<\/td>\n<td align="right">\n<a target="_blank" href="https://www.subpesca.cl">\n<img src="../images/ico/subpesca.png" height="20" /><\/a><\/td><\/tr>';infowindow.setContent(t);infowindow.open(map,this)},addListenerOnPolygon=function(n){$.isEmptyObject(n)?psmb.getValue(!0).includes(this.zIndex)?this.setOptions({fillColor:selected,strokeColor:selected}):this.setOptions({fillColor:undefined,strokeColor:undefined}):psmb.getValue(!0).includes(this.zIndex)?(this.setOptions({fillColor:undefined,strokeColor:undefined}),psmb.removeActiveItemsByValue(this.zIndex)):(this.setOptions({fillColor:selected,strokeColor:selected}),psmb.setChoiceByValue(this.zIndex))},processMapData=function(n){var t=new google.maps.Polygon({paths:n.position,zIndex:n.id}),i,r;return t.setMap(map),t.addListener("click",addListenerOnPolygon),polygons[n.id]=t,i=getBounds(n.position).getCenter(),n.id<4&&bnds.extend(i),r=new google.maps.Marker({position:i,title:n.name+" "+n.id,zIndex:n.id}),tableInfo[n.id]={name:n.name,comuna:n.comuna,provincia:n.provincia,code:n.code},r.addListener("click",showInfo),r},chart=am4core.create("chartdiv",am4charts.XYChart),dateAxis=chart.xAxes.push(new am4charts.DateAxis);dateAxis.dataFields.category="date";var valueAxis=chart.yAxes.push(new am4charts.ValueAxis),chartloaded=!1,loadChart=function(){am4core.useTheme(am4themes_kelly);chart.language.locale=esp?am4lang_es_ES:am4lang_en_US;chart.scrollbarY=new am4core.Scrollbar;chart.scrollbarX=new am4core.Scrollbar;chart.zoomOutButton.align="left";chart.zoomOutButton.valign="bottom";dateAxis.dateFormats.setKey("year","yy");dateAxis.periodChangeDateFormats.setKey("month","MMM yy");dateAxis.tooltipDateFormat="dd MMM, yyyy";dateAxis.renderer.minGridDistance=40;chart.legend=new am4charts.Legend;var n=am4core.create("legenddiv",am4core.Container);n.width=am4core.percent(100);n.height=am4core.percent(100);chart.legend.parent=n;chart.cursor=new am4charts.XYCursor;chart.exporting.menu=new am4core.ExportMenu;semaforo||(chart.exporting.formatOptions.getKey("png").disabled=!0,chart.exporting.formatOptions.getKey("svg").disabled=!0,chart.exporting.formatOptions.getKey("pdf").disabled=!0,chart.exporting.formatOptions.getKey("json").disabled=!0,chart.exporting.formatOptions.getKey("csv").disabled=!0,chart.exporting.formatOptions.getKey("xlsx").disabled=!0,chart.exporting.formatOptions.getKey("html").disabled=!0,chart.exporting.formatOptions.getKey("pdfdata").disabled=!0);chartloaded=!0;chart.events.off("validated",loadChart)};chart.events.on("validated",loadChart);var loadDates=function(){for(var t=$("#start").val(),i=$("#end").val(),n=moment(t),r=moment(i);n<=r;)chart.data.push({date:n.format("yyyy-MM-DD")}),n.add(1,"days");return chart.data},fetchData=function(n,t,i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(r){switch(r.label){case 0:return!(t in chart.exporting.dataFields)?(chart.exporting.dataFields[t]=i,[4,fetch(n).then(function(n){return n.json()}).then(function(n){var u=0,r;chart.data.map(function(i){u<n.length&&i.date===n[u].date&&(i[t]=n[u].value,u++)});r=chart.series.push(new am4charts.LineSeries);r.dataFields.valueY=t;r.dataFields.dateX="date";r.name=i;r.tooltipText="{name}: [bold]{valueY}[/]";r.showOnInit=!1}).catch(function(){delete chart.exporting.dataFields[t]})]):[3,2];case 1:return[2,r.sent()];case 2:return[2]}})})},generatefetchData=function(n,t,i,r){return __awaiter(this,void 0,void 0,function(){var u,f,e;return __generator(this,function(){return u=n.value+"_"+t.value,f=n.label+" "+t.label,e="/ambiental/data?area="+t.value+"&type="+n.value.charAt(0)+"&id="+n.value.substring(1)+"&start="+i+"&end="+r,[2,fetchData(e,u,f)]})})},loadData=function(n,t){return __awaiter(this,void 0,void 0,function(){var i,r,u,f;return __generator(this,function(){return(i=t?variables.getValue():psmb.getValue(),i.length===0)?[2]:(loaderStart(),r=$("#start").val(),u=$("#end").val(),f=t?i.map(function(t){return generatefetchData(t,n.detail,r,u)}):i.map(function(t){return generatefetchData(n.detail,t,r,u)}),Promise.all(f).then(function(){chart.invalidateData()}),[2])})})},supportsPassiveOption=!1;try{opts=Object.defineProperty({},"passive",{get:function(){supportsPassiveOption=!0;return}});noop=function(){};window.addEventListener("testPassiveEventSupport",noop,opts);window.removeEventListener("testPassiveEventSupport",noop,opts)}catch(e){}passive=supportsPassiveOption?{passive:!0}:!1;evariable.addEventListener("addItem",function(n){return loadData(n,!1)},passive);evariable.addEventListener("removeItem",function(n){psmb.getValue(!0).forEach(function(t){var i=n.detail.value+"_"+t;chart.series.values.forEach(function(n,t){n.dataFields.valueY===i&&(delete chart.exporting.dataFields[i],chart.series.removeIndex(t).dispose())})})},passive);clickMap=function(n){n!==undefined&&polygons[n.detail.value]!==undefined&&google.maps.event.trigger(polygons[n.detail.value],"click",{})};epsmb.addEventListener("addItem",function(n){loadData(n,!0);clickMap(n)},passive);epsmb.addEventListener("removeItem",function(n){variables.getValue(!0).forEach(function(t){var i=t+"_"+n.detail.value;chart.series.values.forEach(function(n,t){n.dataFields.valueY===i&&(delete chart.exporting.dataFields[i],chart.series.removeIndex(t).dispose())})});clickMap(n)},passive);var getList=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,fetch("/json/"+n+"list.json").then(function(n){return n.json()}).catch(function(t){return console.error(t,n)})];case 1:return[2,t.sent()]}})})},loaderStopped=function(){return new Promise(function(n){(function t(){if(document.getElementById("preloader-background").style.display==="none")return n();setTimeout(t,400)})()})},chartLoaded=function(){return new Promise(function(n){(function t(){if(chartloaded)return n();setTimeout(t,400)})()})},init=function(){return __awaiter(this,void 0,void 0,function(){var t,l,a,o,s,h,i,r,c,v,y,p,w,b,k,n,u,f,e;return __generator(this,function(){return loadDates(),t=fetch("/json/cuencadata.json").then(function(n){return n.json()}).then(function(n){return n.map(processMapData)}).then(function(n){markers=n;map.fitBounds(bnds);map.setCenter(bnds.getCenter())}),l=getList("oceanvar"),a=getList("cuenca"),o=fetch("/json/comunadata.json").then(function(n){return n.json()}).then(function(n){return n.map(processMapData)}).then(function(n){return markers=markers.concat(n)}),s=getList("comuna"),h=getList("groupvar"),i=Promise.all([l]).then(function(n){return variables.setChoices([n[0]]),!0}),r=Promise.all([a]).then(function(n){return psmb.setChoices([n[0]]),!0}),c=Promise.all([i,r,t]).then(function(){return variables.setChoiceByValue("v0"),psmb.setChoiceByValue(1),chartLoaded()}),semaforo?(v=fetch("/json/psmbdata.json").then(function(n){return n.json()}).then(function(n){return n.map(processMapData)}).then(function(n){return markers=markers.concat(n)}),y=getList("psmb"),p=getList("genusvar"),w=getList("speciesvar"),b=getList("tl"),u=Promise.all([r,s,y]).then(function(n){return psmb.setChoices(n[1].concat(n[2])),!0}),f=Promise.all([i,h,p,w]).then(function(n){return variables.setChoices([n[1],n[2],n[3]]),!0}),k=Promise.all([b]).then(function(n){return tl.setChoices(n[0]),!0}),e=Promise.all([t,o,v]).then(function(){return new MarkerClusterer(map,markers,{imagePath:"/images/markers/m"})}),n=function(n,t,i,r,u,f,e){var o=e===0,s=o?r.map(function(r){return u.map(function(u){var f=[n.value,r.value,u.value].join("_"),e,o;if(!chart.series._values.some(function(n){return f===n.dataFields.valueY}))return e=[n.label,r.label,u.label.replace("<i>","[bold font-style: italic]").replace("<\/i>","[/]")].join(" "),o="/ambiental/tldata?a="+n.value+"&psmb="+r.value+"&sp="+u.value+"&start="+t+"&end="+i,fetchData(o,f,e)})}):f.filter(function(n){return Math.floor(n.value/10)===e}).map(function(f){return r.map(function(r){return u.map(function(u){var e=[n.value,r.value,u.value,f.value].join("_"),o,s;if(!chart.series._values.some(function(n){return e===n.dataFields.valueY}))return o=[n.label,r.label,u.label.replace("<i>","[bold font-style: italic]").replace("<\/i>","[/]"),f.label].join(" "),s="/ambiental/tldata?a="+n.value+"&psmb="+r.value+"&sp="+u.value+"&v="+f.value+"&start="+t+"&end="+i,fetchData(s,e,o)})})});return Promise.all(s).then(function(n){return n})},etl.addEventListener("addItem",function(){var t=tl.getValue(),e=t.filter(function(n){return Math.floor(n.value/10)===1}),i,r,u,f;e.length!==0&&(i=t.filter(function(n){return Math.floor(n.value/10)===2}),r=t.filter(function(n){return Math.floor(n.value/10)===3}),i.length!==0&&r.length!==0&&(loaderStart(),u=$("#start").val(),f=$("#end").val(),e.forEach(function(e){switch(e.value){case 14:case 17:return n(e,u,f,i,r,null,0);case 11:return n(e,u,f,i,r,t,4);case 12:return n(e,u,f,i,r,t,5);case 15:return n(e,u,f,i,r,t,6);case 13:case 16:return n(e,u,f,i,r,t,7);default:return}}),chart.invalidateData()))},passive),etl.addEventListener("removeItem",function(n){if(chart.series.values.length!==0){var i=chart.series.values.map(function(n){return n.dataFields.valueY}),r=n.detail.value,t=0;i.forEach(function(n,i){n.match(/^[1-7][0-8]_[1-7][0-8]_[1-7][0-8](_[1-7][0-8])?$/g)&&n.includes(r)&&(delete chart.exporting.dataFields[n],chart.series.removeIndex(i-t).dispose(),t++)})}},passive),Promise.all([c,u,f,k,e]).then(function(){chart.events.on("validated",loaderStop);loaderStop()})):(u=Promise.all([r,s]).then(function(n){return psmb.setChoices(n[1]),!0}),f=Promise.all([i,h]).then(function(n){return variables.setChoices([n[1]]),!0}),e=Promise.all([t,o]).then(function(){return new MarkerClusterer(map,markers,{imagePath:"/images/markers/m"})}),Promise.all([c,u,f,e]).then(function(){chart.events.on("validated",loaderStop);loaderStop()})),[2]})})};init();$(".input-daterange").datepicker({inputs:$(".actual_range"),format:"yyyy-mm-dd",language:lang,startDate:$("#start").val().toString(),endDate:$("#end").val().toString()}).on("changeDate",function(){var t=variables.getValue(!0),n;variables.removeActiveItems();semaforo&&(n=tl.getValue(!0),tl.removeActiveItems());chart.data=[];loadDates();t.forEach(function(n){return variables.setChoiceByValue(n)});semaforo&&n.forEach(function(n){return tl.setChoiceByValue(n)})});var CreateTableFromJSON=function(n){for(var e,r,u,o,f,s,h,i=[],t=0;t<n.length;t++)for(e in n[t])i.indexOf(e)===-1&&i.push(e);for(r=document.createElement("table"),r.className="table",r.id="newTable",u=r.insertRow(-1),t=0;t<i.length;t++)o=document.createElement("th"),o.innerHTML=i[t],u.appendChild(o);for(t=0;t<n.length;t++)for(u=r.insertRow(-1),f=0;f<i.length;f++)s=u.insertCell(-1),s.innerHTML=n[t][i[f]];h=document.getElementById("results");h.appendChild(r)},fetchPlankton=function(){var n=$("#start").val(),t=$("#end").val(),i=psmb.getValue(!0).map(function(i){return fetch("/ambiental/BuscarInformes",{method:"POST",headers:new Headers({"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}),body:"id="+i+"&start="+n+"&end="+t}).then(function(n){return n.json()})});Promise.all(i).then(function(n){var t=document.getElementById("results");t.innerHTML="";n.forEach(function(n){return CreateTableFromJSON(n)})})},tableToExcel=function(){var n="data:application/vnd.ms-excel;base64,",t='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}<\/x:Name><x:WorksheetOptions><x:DisplayGridlines/><\/x:WorksheetOptions><\/x:ExcelWorksheet><\/x:ExcelWorksheets><\/x:ExcelWorkbook><\/xml><![endif]--><\/head><body><table>{table}<\/table><\/body><\/html>',i=function(n){return window.btoa(unescape(encodeURIComponent(n)))},r=function(n,t){return n.replace(/{(\w+)}/g,function(n,i){return t[i]})};return function(u,f){u.nodeType||(u=document.getElementById(u));var e={worksheet:f||"Worksheet",table:u.innerHTML};window.location.href=n+i(r(t,e))}}();document.getElementById("legenddiv").addEventListener("DOMSubtreeModified",function(){document.getElementById("legenddiv").style.height=chart.legend.contentHeight+"px"});