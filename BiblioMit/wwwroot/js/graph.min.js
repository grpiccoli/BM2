function fetchData(n,t,i){return fetch(n).then(function(n){return n.json()}).then(function(n){var r=0;chart.data.forEach(function(i){r<n.length&&i.date==n[r].date&&(i[t]=n[r].value,r++)});series[t]=chart.series.push(new am4charts.LineSeries);series[t].dataFields.valueY=t;series[t].dataFields.dateX="date";series[t].name=i;series[t].tooltipText="{name}: [bold]{valueY}[/]";series[t].tooltip.pointerOrientation="vertical"})}function loadData(n,t,i){return __awaiter(this,void 0,void 0,function(){var r,u,f;return __generator(this,function(){return psmb.disable(),variables.disable(),semaforo&&tl.disable(),r=$("#start").val(),u=$("#end").val(),f=n.map(function(n){var f=i?[n.value,t.value,n.label,t.label,n.groupId===2?"fito":"graph"]:[t.value,n.value,t.label,n.label,t.groupValue==="Fitoplancton"?"fito":"graph"],e=f[0]+"_"+f[1],o=f[2]+" "+f[3],s="/ambiental/"+f[4]+"data?area="+f[1]+"&var="+f[0]+"&start="+r+"&end="+u;return fetchData(s,e,o)}),Promise.all(f).then(function(){chart.invalidateData();psmb.enable();variables.enable();semaforo&&tl.enable()}),[2]})})}function clickMap(n){n!==undefined&&polygons[n.detail.value]!==undefined&&google.maps.event.trigger(polygons[n.detail.value],"click",{})}function getList(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,fetch("/ambiental/"+n+"list").then(function(n){return n.json()}).catch(function(n){return console.error(n)})];case 1:return[2,t.sent()]}})})}function getParam(n,t){switch(n){case"11":return"&t="+t.value.slice(1,2);case"12":return"&l="+t.value;case"13":case"16":return"&s="+t.value;case"15":return"&rs="+t.value;default:return""}}function Area(n){return(google.maps.geometry.spherical.computeArea(n)/1e4).toFixed(2)}function addListenerOnPolygon(n){$.isEmptyObject(n)?psmb.getValue(!0).includes(this.zIndex.toString())?this.setOptions({fillColor:selected,strokeColor:selected}):this.setOptions({fillColor:undefined,strokeColor:undefined}):psmb.getValue(!0).includes(this.zIndex.toString())?(this.setOptions({fillColor:undefined,strokeColor:undefined}),psmb.removeActiveItemsByValue(this.zIndex.toString())):(this.setOptions({fillColor:selected,strokeColor:selected}),psmb.setChoiceByValue(this.zIndex.toString()))}function flatten(n){var t=[];return n.forEach(function(n){Array.isArray(n)?t.push.apply(t,flatten(n)):t.push(n)}),t}function getBounds(n){var t=new google.maps.LatLngBounds;return flatten(n).forEach(function(n){return t.extend(n)}),t}function loadDates(){for(var t=$("#start").val(),i=$("#end").val(),n=moment(t),r=moment(i);n<=r;)chart.data.push({date:n.format("yyyy-MM-DD")}),n.add(1,"days")}var __awaiter=this&&this.__awaiter||function(n,t,i,r){function u(n){return n instanceof i?n:new i(function(t){t(n)})}return new(i||(i=Promise))(function(i,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?i(n.value):u(n.value).then(o,s)}e((r=r.apply(n,t||[])).next())})},__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},_this=this,chart,dataSource,dateAxis,valueAxis,tl,semaforo,epsmb,psmb,evariable,variables,selected;am4core.useTheme(am4themes_kelly);chart=am4core.create("chartdiv",am4charts.XYChart);chart.scrollbarX=new am4core.Scrollbar;chart.scrollbarX.parent=chart.bottomAxesContainer;chart.scrollbarY=new am4core.Scrollbar;chart.scrollbarY.parent=chart.leftAxesContainer;chart.language.locale=am4lang_es_ES;dataSource=chart.dataSource;dateAxis=chart.xAxes.push(new am4charts.DateAxis);dateAxis.dataFields.category="date";dateAxis.dateFormats.setKey("year","yy");dateAxis.periodChangeDateFormats.setKey("month","MMM yy");dateAxis.tooltipDateFormat="dd MMM, yyyy";dateAxis.renderer.minGridDistance=40;valueAxis=chart.yAxes.push(new am4charts.ValueAxis);chart.cursor=new am4charts.XYCursor;chart.cursor.xAxis=dateAxis;chart.exporting.menu=new am4core.ExportMenu;$.getJSON("/ambiental/exportmenu",function(n){return chart.exporting.menu.items=n});var series={},choiceOps={maxItemCount:10,removeItemButton:!0,duplicateItemsAllowed:!1,paste:!1,searchResultLimit:10,shouldSort:!1,placeholderValue:"Seleccione áreas",searchPlaceholderValue:"Buscar datos",loadingText:"Cargando...",noResultsText:"Sin resultados",noChoicesText:"Sin opciones a elegir",itemSelectText:"Presione para seleccionar",maxItemText:function(n){return"Máximo "+n+" valores"},fuseOptions:{include:"score"}},etl=document.getElementById("tl");choiceOps.placeholderValue="Variables semáforo";tl=new Choices(etl,choiceOps);semaforo=!document.getElementById("semaforo").classList.contains("d-none");epsmb=document.getElementById("psmb");epsmb.addEventListener("addItem",function(n){loadData(variables.getValue(),n.detail,!0);clickMap(n)},!1);epsmb.addEventListener("removeItem",function(n){variables.getValue(!0).forEach(function(t){var i=t+"_"+n.detail.value;chart.series.removeIndex(chart.series.indexOf(series[i])).dispose()});clickMap(n)},!1);psmb=new Choices(epsmb,choiceOps);psmb.setChoices(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(n){switch(n.label){case 0:return[4,getList("psmb")];case 1:return[2,n.sent()]}})})});evariable=document.getElementById("variable");evariable.addEventListener("addItem",function(n){return loadData(psmb.getValue(),n.detail,!1)},!1);evariable.addEventListener("removeItem",function(n){psmb.getValue(!0).forEach(function(t){var i=n.detail.value+"_"+t;chart.series.removeIndex(chart.series.indexOf(series[i])).dispose()})},!1);choiceOps.placeholderValue="Seleccione variables";variables=new Choices(evariable,choiceOps);variables.setChoices(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(n){switch(n.label){case 0:return[4,getList("variable")];case 1:return[2,n.sent()]}})})});semaforo&&(etl.addEventListener("addItem",function(n){var r,o,u;if(n.detail.groupValue==="Análisis"){var t=n.detail.value,i=tl.getValue(),f=i.filter(function(n){return n.groupId===2}),e=i.filter(function(n){return n.groupId===3});if(f.length!==0&&e.length!==0)if(r=n.detail.id,o=n.detail.groupValue,console.log(n.detail),u=r==0?{value:"",name:""}:i.filter(function(n){return n.groupId===r}),u=i.filter(function(n){return n.groupId===r}),u.length!==0){psmb.disable();variables.disable();tl.disable();var s=$("#start").val(),h=$("#end").val(),c=f.map(function(i){return e.map(function(r){return u.map(function(u){var f=[t,i.value,r.value,u.value].join("_"),e=[n.detail.name,i.name,r.name,u.name].join(" "),o="/ambiental/tldata?a="+t+"&psmb="+i.value+"&sp="+r.value+getParam(t,u)+"&start="+s+"&end="+h;return fetchData(o,f,e)})})});Promise.all(c).then(function(){chart.invalidateData();psmb.enable();variables.enable();tl.enable()})}else alert(o+" no seleccionada, seleccione requerimientos y luego análisis");else tl.removeActiveItemsByValue(t),alert("PSMB y especie no seleccionados, seleccione requerimientos y luego análisis")}},!1),etl.addEventListener("removeItem",function(n){var e,i;if(n.detail.groupValue==="Análisis"){var r=n.detail.value,t=tl.getValue(),u=t.filter(function(n){return n.groupId===2}),f=t.filter(function(n){return n.groupId===3});u.length!==0&&f.length!==0&&(psmb.disable(),variables.disable(),tl.disable(),e=r-7,i=t.filter(function(n){return n.groupId===e}),i.length!==0&&u.forEach(function(n){return f.forEach(function(t){return i.forEach(function(i){var u=[r,n.value,t.value,i.value].join("_");chart.series.removeIndex(chart.series.indexOf(series[u])).dispose()})})}))}},!1),tl.setChoices(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(n){switch(n.label){case 0:return[4,getList("tl")];case 1:return[2,n.sent()]}})})}),new tippy("#infobtn",{content:document.getElementById("infotable").innerHTML,allowHTML:!0,animation:"scale"}));selected="red";var map=new google.maps.Map(document.getElementById("map"),{mapTypeId:"terrain"}),infowindow=new google.maps.InfoWindow({maxWidth:150}),polygons={};window.onload=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(n){switch(n.label){case 0:return[4,fetch("/ambiental/mapdata").then(function(n){return n.json()}).then(function(n){var t=getBounds(n.slice(0,3).map(function(n){return n.position}));return map.fitBounds(t),map.setCenter(t.getCenter()),n.map(function(n){var t=new google.maps.Polygon({paths:n.position,zIndex:n.id}),i;return t.setMap(map),t.addListener("click",addListenerOnPolygon),polygons[n.id]=t,i=new google.maps.Marker({position:getBounds(n.position).getCenter(),title:n.name+" "+n.id}),i.addListener("click",function(i){return function(){var r="<h4>"+n.name+'<\/h4><table><tr><th>Código<\/th><td align="right">'+n.id+"<\/td><\/tr>";n.comuna!==null&&(r+='<tr><th>Comuna<\/th><td align="right">'+n.comuna+"<\/td><\/tr>");n.provincia!==null&&(r+='<tr><th>Provincia<\/th><td align="right">'+n.provincia+"<\/td><\/tr>");r+='<tr><th>Región<\/th><td align="right">'+n.region+'<\/td>\n<\/tr><tr><th>Área (ha)<\/th>\n<td align="right">'+Area(t.getPath().getArray())+'<\/td>\n<\/tr>\n<tr><th>Fuentes<\/th><td><\/td><\/tr>\n<tr><td>Sernapesca<\/td>\n<td align="right">\n<a target="_blank" href="https://www.sernapesca.cl">\n<img src="../images/ico/sernapesca.svg" height="30" /><\/a><\/td><\/tr>\n<tr><td>PER Mitilidos<\/td>\n<td align="right">\n<a target="_blank" href="https://www.mejillondechile.cl">\n<img src="../images/ico/mejillondechile.min.png" height="30" /><\/a><\/td><\/tr>\n<tr><td>Subpesca<\/td>\n<td align="right">\n<a target="_blank" href="https://www.subpesca.cl">\n<img src="../images/ico/subpesca.png" height="30" /><\/a><\/td><\/tr>';infowindow.setContent(r);infowindow.open(map,i);map.setCenter(i.getPosition())}}(i)),i})}).then(function(n){return new MarkerClusterer(map,n,{imagePath:"https://unpkg.com/@google/markerclustererplus/images/m"})}).then(function(){loadDates();variables.setChoiceByValue("t");psmb.setChoiceByValue("1")})];case 1:return n.sent(),[2]}})})};$(".input-daterange").datepicker({inputs:$(".actual_range"),format:"yyyy-mm-dd",language:"es",startDate:$("#start").val().toString(),endDate:$("#end").val().toString()}).on("changeDate",function(){var n=variables.getValue(!0);variables.removeActiveItems();chart.data=[];loadDates();n.forEach(function(n){return variables.setChoiceByValue(n)})});